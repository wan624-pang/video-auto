# 剪映自动化剪辑方案与执行清单

本文档是对“图片 + 音频 + 文字”自动化剪辑（含转场、动画、BGM ducking、后期特效）的方案设计与执行清单。确认后再进入开发。


## 1. 目标与边界
- 目标：将已生成的每段素材（图片、对应音频、对应文本）自动编排到剪映草稿（CapCut/JianyingPro draft），实现时间线布局、转场与后期设置，打开剪映后可直接预览或微调导出。
- 上游（你负责）：文本切分、提示词、生成图片、生成音频。
- 本模块（我负责）：自动把图片、音频、文本落到剪映工程（草稿 JSON），控制时长、转场、动画、BGM ducking、全局特效等。


## 2. 输入/输出契约（manifest.json）
- 输入（建议采用 manifest.json 文件）：
  - 全局配置 project：画面参数、BGM/ducking、默认转场/动画/样式、开场/片尾/水印等。
  - 段列表 segments[]：每段音频、图片（1-N）、文字内容与可选的覆盖配置（样式、转场、Ken Burns 等）。
- 输出：
  - 生成或更新剪映草稿 draft_content.json，包含：
    - 图片主轨道（段内多图）
    - 语音轨道
    - 文字叠加轨
    - 背景音乐轨（含 ducking）
    - 特效轨（可选全局滤镜/LUT/胶片颗粒等）

详见：
- docs/manifest.schema.json（JSON Schema 草案）
- examples/manifest.example.json（样例）


## 3. 时间线与轨道设计
- 轨道：
  - 图片主轨道：按段排列，段内多图分配时长；Ken Burns（平移/缩放）+ 入/出场动画；段间转场。
  - 语音轨道：每段一个音频片段（精准起止，支持短淡入/淡出）。
  - 文字叠加轨：每段一个文本片段（随语音时长）；支持样式与入场动画。
  - 背景音乐轨：整段铺满或裁剪；对解说段落做 ducking（自动压低）。
  - 特效轨：全局滤镜/LUT/颗粒/暗角（可选）。
- 时间基准：
  - 以每段“音频”实际时长为准。
  - 段间转场占用前后片段边缘时间；若使用入/出场动画，也可不做重叠（更简单）。


## 4. 核心算法要点
- 段起止与累加：
  - segment_i.start = segment_(i-1).end
  - 若图像转场需要 300ms 重叠，则 image_i.end = audio_i.end + overlap_margin，或在入/出动画中模拟交叉（推荐，避免复杂时序计算）。
- 段内多图分配：
  - base = audio_duration_i
  - N 张图时，先均分：d = base / N
  - 若 d < min_image_duration：
    - 策略 A（推荐）：保持总时长不变，允许相邻图片以转场时长重叠（交叉淡化），每张图“名义时长”提升到 min，实际 target_timerange 通过重叠控制总长度。
    - 策略 B（降级）：缩短每张至相等但 ≥ min/2，并开启较强的入/出动画以掩盖跳切。
- BGM ducking：
  - 对每段解说 [s, e]，在 BGM 轨上施加音量包络：
    - 进入解说前 prepad_ms 开始下降，下降到 reduce_db；离开解说后 postpad_ms 逐步恢复。
    - 使用 attack_ms / release_ms 平滑过渡。
- 文本布局：
  - 默认底部居中，设置最大宽度百分比和行距，自动换行。
  - 可配置字体、字号、颜色、描边、阴影、入场动画。


## 5. 执行任务清单（阶段划分）
- 阶段 A：契约与样例
  1) 定义 manifest.json 字段与默认值。
  2) 提供最小样例（2 段：单图 + 多图 + 语音 + 文本 + BGM）。

- 阶段 B：工程与能力扩展
  1) TimelineBuilder：管理段起止、重叠与分配。
  2) Config：解析 manifest，支持全局 + 每段覆盖。
  3) BackupManager：保存前备份草稿。
  4) Logger & 校验：路径存在性、缺失容错。

- 阶段 C：素材导入（materials）
  1) 图片 → materials.videos（type=photo）。
  2) 音频 → materials.audios（记录路径、时长）。
  3) 文本 → 直接在轨道生成（或视剪映版本决定是否预入库）。

- 阶段 D：轨道构建
  1) 语音轨：每段一个音频 segment；可选 20–100ms 交叉淡化。
  2) 图片主轨：单图/多图分配，Ken Burns + 入/出动画，段间转场。
  3) 文字叠加轨：与语音同起止，样式与动画可覆盖。
  4) BGM 轨：铺满 + ducking 包络。
  5) 特效轨：全局滤镜/LUT/胶片颗粒等（可选）。

- 阶段 E：容错与兼容
  1) 素材缺失：占位/跳过策略。
  2) 时长过短：合并/重叠/降级策略。
  3) 剪映 JSON 版本兼容：字段名/轨道类型/动画引用适配。

- 阶段 F：验证与示例
  1) 用样例 manifest 生成草稿，剪映打开无报错。
  2) 检查：对齐、转场/动画、文字样式、BGM ducking。
  3) 导出一次短视频验证视听效果。

- 阶段 G：文档与预设
  1) README 增补 manifest 字段说明与常见问题。
  2) 提供多套风格预设（横/竖屏、不同转场与文字风格）。


## 6. 可配置项清单
- 画面：分辨率/比例、FPS、图片适配（contain/cover）、Ken Burns 方向/幅度、min_image_duration。
- 文字：字体、字号、颜色、描边/阴影、位置、最大宽度、行距、入/出动画与时长。
- 转场：类型（淡入淡出/平移/缩放/百叶窗/翻页）、时长、是否统一。
- 音频：narration_volume、bgm_volume、ducking（reduce_db、attack/release、prepad/postpad）、段间交叉淡化时长。
- 全局：开场/片尾/水印、滤镜、LUT、颗粒/暗角/锐化开关。


## 7. 验收标准（DoD）
- 读取 manifest 并生成剪映草稿；
- 每段音频/图片/文字对齐准确，段内多图分配合理；
- 段间转场与图片动画生效；
- BGM 铺满并对解说区域自动 ducking；
- 剪映打开无结构错误，可直接预览与导出；
- 可通过预设快速切换全局风格（至少两套）。


## 8. 待确认问题
1) manifest.json 是否采用本文建议的结构？每段是否允许多图、多文本与独立样式？
2) 默认画幅（16:9 / 9:16 / 1:1）与目标平台（YouTube / TikTok）。
3) 默认文字样式（字体、颜色、描边）与默认转场/动画列表。
4) BGM 策略：固定一条、自动循环、是否按片段切换不同 BGM？
5) 是否需要开场/片尾/水印模板元素？
6) 是否需要逐词高亮（卡拉 OK）效果（若需要需词级时间戳）。
